# PDFåŠŸèƒ½éƒ¨ç½²è¯´æ˜

## ğŸ“¦ Gitæäº¤ä¿¡æ¯

**Commit**: `6ba22ea`
**Branch**: `main`
**æäº¤æ—¶é—´**: 2024-12-01

**æäº¤ä¿¡æ¯**:
```
feat: å®ç°PDFç´ æä¸Šä¼ åŠŸèƒ½

- æ·»åŠ PDFæ–‡ä»¶ä¸Šä¼ æ”¯æŒï¼ˆæœ€å¤§500MBï¼‰
- ä½¿ç”¨pdfjs-distè‡ªåŠ¨å°†PDFç¬¬ä¸€é¡µè½¬æ¢ä¸ºPNGå°é¢
- ä¿å­˜åŸå§‹PDFæ–‡ä»¶åˆ°originals/ç›®å½•
- æ”¯æŒAIåˆ†æPDFå°é¢å›¾ç‰‡ç”Ÿæˆæ ‡ç­¾å’Œæç¤ºè¯
- åœ¨ç´ æåº“æ˜¾ç¤ºçº¢è‰²PDFæ ‡è¯†
- æ·»åŠ PDFæ–‡ä»¶ä¸‹è½½åŠŸèƒ½
- æ›´æ–°å‰ç«¯æ”¯æŒPDFæ–‡ä»¶é€‰æ‹©å’Œæ‹–æ‹½ä¸Šä¼ 
- æ·»åŠ å®Œæ•´çš„åŠŸèƒ½æ–‡æ¡£å’Œæµ‹è¯•æŒ‡å—
```

## ğŸ”§ éƒ¨ç½²å‰å‡†å¤‡

### 1. ä¾èµ–å®‰è£…

ç”Ÿäº§ç¯å¢ƒéœ€è¦å®‰è£…æ–°çš„ä¾èµ–ï¼š

```bash
npm install
```

**æ–°å¢ä¾èµ–**ï¼š
- `pdfjs-dist` - PDFè§£æå’Œæ¸²æŸ“
- `pdf-lib` - PDFå¤„ç†è¾…åŠ©åº“

**å·²æœ‰ä¾èµ–**ï¼ˆç¡®ä¿å·²å®‰è£…ï¼‰ï¼š
- `canvas@^3.2.0` - PDFæ¸²æŸ“åˆ°å›¾ç‰‡
- `sharp@^0.34.5` - å›¾ç‰‡å¤„ç†
- `ag-psd@^28.5.1` - PSDæ–‡ä»¶å¤„ç†

### 2. ç³»ç»Ÿä¾èµ–

**é‡è¦**ï¼š`canvas`åº“éœ€è¦ç³»ç»Ÿçº§ä¾èµ–

#### Linux (Ubuntu/Debian)
```bash
sudo apt-get install build-essential libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
```

#### Linux (CentOS/RHEL)
```bash
sudo yum install gcc-c++ cairo-devel pango-devel libjpeg-turbo-devel giflib-devel
```

#### macOS
```bash
brew install pkg-config cairo pango libpng jpeg giflib librsvg
```

#### Windows
é€šå¸¸ä¸éœ€è¦é¢å¤–é…ç½®ï¼Œä½†å¯èƒ½éœ€è¦ï¼š
- Visual Studio Build Tools
- Python 2.7 æˆ– 3.x

### 3. ç¯å¢ƒå˜é‡

ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆ`.env.production`æˆ–ç¯å¢ƒé…ç½®ï¼‰ï¼š

```env
# Supabaseé…ç½®ï¼ˆå¿…éœ€ï¼‰
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# OpenRouter APIï¼ˆå¿…éœ€ï¼Œç”¨äºAIåˆ†æï¼‰
OPENROUTER_API_KEY=your_openrouter_api_key
```

### 4. Supabaseå­˜å‚¨é…ç½®

ç¡®ä¿Supabaseå­˜å‚¨æ¡¶é…ç½®æ­£ç¡®ï¼š

1. **å­˜å‚¨æ¡¶**: `material`
   - å¿…é¡»å­˜åœ¨
   - å…è®¸å…¬å…±è¯»å–
   - å¤§å°é™åˆ¶ â‰¥ 500MB

2. **æ–‡ä»¶å¤¹ç»“æ„**:
   ```
   material/
   â”œâ”€â”€ originals/     # åŸå§‹PSD/PDFæ–‡ä»¶
   â””â”€â”€ [å…¶ä»–æ–‡ä»¶]      # PNGå°é¢å›¾
   ```

3. **æƒé™è®¾ç½®**:
   ```sql
   -- å…è®¸å…¬å…±è¯»å–
   CREATE POLICY "Public Access"
   ON storage.objects FOR SELECT
   USING ( bucket_id = 'material' );
   
   -- å…è®¸è®¤è¯ç”¨æˆ·ä¸Šä¼ 
   CREATE POLICY "Authenticated Upload"
   ON storage.objects FOR INSERT
   WITH CHECK ( bucket_id = 'material' AND auth.role() = 'authenticated' );
   ```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. æ‹‰å–ä»£ç 
```bash
git pull origin main
```

### 2. å®‰è£…ä¾èµ–
```bash
npm install
```

### 3. æ„å»ºé¡¹ç›®
```bash
npm run build
```

### 4. å¯åŠ¨æœåŠ¡
```bash
npm start
# æˆ–ä½¿ç”¨PM2
pm2 start npm --name "ai-manga-tool" -- start
```

## âœ… éƒ¨ç½²åéªŒè¯

### 1. å¥åº·æ£€æŸ¥
```bash
curl http://your-domain.com/api/health
```

### 2. åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•PDFä¸Šä¼ **ï¼š
1. è®¿é—®åº”ç”¨
2. è¿›å…¥"ç´ æä¸Šä¼ "
3. é€‰æ‹©åˆ†ç±»
4. ä¸Šä¼ ä¸€ä¸ªå°PDFæ–‡ä»¶ï¼ˆ<5MBï¼‰
5. éªŒè¯ï¼š
   - PDFèƒ½æ­£å¸¸ä¸Šä¼ 
   - æ˜¾ç¤ºç¬¬ä¸€é¡µé¢„è§ˆ
   - AIåˆ†ææˆåŠŸ
   - ç´ æåº“æ˜¾ç¤ºçº¢è‰²"PDF"æ ‡è¯†
   - å¯ä»¥ä¸‹è½½åŸå§‹PDF

**æµ‹è¯•ç°æœ‰åŠŸèƒ½**ï¼š
1. ä¸Šä¼ æ™®é€šå›¾ç‰‡ï¼ˆPNG/JPGï¼‰- åº”è¯¥æ­£å¸¸
2. ä¸Šä¼ PSDæ–‡ä»¶ - åº”è¯¥æ­£å¸¸
3. ä¸‹è½½ç´ æ - åº”è¯¥æ­£å¸¸
4. AIåˆ†æ - åº”è¯¥æ­£å¸¸

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### 1. å†…å­˜ä½¿ç”¨
- PDFæ¸²æŸ“éœ€è¦è¾ƒå¤šå†…å­˜
- å»ºè®®æœåŠ¡å™¨å†…å­˜ â‰¥ 2GB
- å¤§PDFæ–‡ä»¶ï¼ˆ>50MBï¼‰å¯èƒ½éœ€è¦æ›´å¤šå†…å­˜

### 2. å¤„ç†æ—¶é—´
- å°PDFï¼ˆ<5MBï¼‰ï¼š10-20ç§’
- ä¸­ç­‰PDFï¼ˆ5-20MBï¼‰ï¼š20-40ç§’
- å¤§PDFï¼ˆ20-50MBï¼‰ï¼š40-90ç§’

### 3. å¹¶å‘é™åˆ¶
- å»ºè®®é™åˆ¶åŒæ—¶å¤„ç†çš„PDFæ•°é‡
- å¯ä»¥ä½¿ç”¨é˜Ÿåˆ—ç³»ç»Ÿï¼ˆå¦‚Bullã€BullMQï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Canvasä¾èµ–
- å¦‚æœcanvaså®‰è£…å¤±è´¥ï¼Œæ£€æŸ¥ç³»ç»Ÿä¾èµ–
- å‚è€ƒï¼šhttps://github.com/Automattic/node-canvas#installation

### 2. æ–‡ä»¶å¤§å°é™åˆ¶
- Next.jsé»˜è®¤é™åˆ¶ï¼š50MB
- å·²åœ¨`next.config.mjs`ä¸­é…ç½®
- å¦‚éœ€æ›´å¤§é™åˆ¶ï¼Œä¿®æ”¹`api.bodyParser.sizeLimit`

### 3. è¶…æ—¶è®¾ç½®
- PDFå¤„ç†å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
- ç¡®ä¿APIè¶…æ—¶è®¾ç½®è¶³å¤Ÿï¼ˆå»ºè®® â‰¥ 120ç§’ï¼‰
- Vercelç­‰å¹³å°å¯èƒ½æœ‰10ç§’é™åˆ¶ï¼Œéœ€è¦è°ƒæ•´

### 4. é”™è¯¯å¤„ç†
- PDFå¤„ç†å¤±è´¥ä¼šè¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯
- æœåŠ¡å™¨æ—¥å¿—åŒ…å«è¯¦ç»†é”™è¯¯å †æ ˆ
- å»ºè®®é…ç½®é”™è¯¯ç›‘æ§ï¼ˆå¦‚Sentryï¼‰

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šcanvaså®‰è£…å¤±è´¥
```bash
# æ£€æŸ¥ç³»ç»Ÿä¾èµ–
pkg-config --modversion cairo

# é‡æ–°å®‰è£…canvas
npm rebuild canvas
```

### é—®é¢˜2ï¼šPDFå¤„ç†è¶…æ—¶
- æ£€æŸ¥æœåŠ¡å™¨èµ„æºï¼ˆCPUã€å†…å­˜ï¼‰
- å¢åŠ APIè¶…æ—¶é™åˆ¶
- è€ƒè™‘ä½¿ç”¨åå°ä»»åŠ¡é˜Ÿåˆ—

### é—®é¢˜3ï¼šå†…å­˜ä¸è¶³
- å¢åŠ æœåŠ¡å™¨å†…å­˜
- é™åˆ¶PDFæ–‡ä»¶å¤§å°
- ä½¿ç”¨æµå¼å¤„ç†

### é—®é¢˜4ï¼šSupabaseä¸Šä¼ å¤±è´¥
- æ£€æŸ¥å­˜å‚¨æ¡¶æƒé™
- éªŒè¯APIå¯†é’¥
- æ£€æŸ¥ç½‘ç»œè¿æ¥

## ğŸ“ å›æ»šæ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼š

```bash
# æŸ¥çœ‹æäº¤å†å²
git log --oneline

# å›æ»šåˆ°ä¸Šä¸€ä¸ªæäº¤
git revert 6ba22ea

# æˆ–è€…ç¡¬å›æ»š
git reset --hard b21b882
git push origin main --force

# é‡æ–°éƒ¨ç½²
npm install
npm run build
npm start
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `PDF-UPLOAD-FEATURE-GUIDE.md` - åŠŸèƒ½ä½¿ç”¨æŒ‡å—
- `PDF-FEATURE-SUMMARY.md` - åŠŸèƒ½æ€»ç»“
- `PDF-IMPLEMENTATION-STATUS.md` - å®ç°çŠ¶æ€
- `PDF-TEST-CHECKLIST.md` - æµ‹è¯•æ¸…å•
- `PDF-TROUBLESHOOTING.md` - æ•…éšœæ’æŸ¥

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœéƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æ£€æŸ¥æ—¥å¿—**ï¼š
   - åº”ç”¨æ—¥å¿—ï¼š`pm2 logs`
   - ç³»ç»Ÿæ—¥å¿—ï¼š`journalctl -u your-service`

2. **éªŒè¯ä¾èµ–**ï¼š
   ```bash
   npm list canvas pdfjs-dist pdf-lib
   ```

3. **æµ‹è¯•canvas**ï¼š
   ```bash
   node -e "const Canvas = require('canvas'); console.log('Canvas OK')"
   ```

## âœ¨ æ–°åŠŸèƒ½è¯´æ˜

### ç”¨æˆ·å¯è§åŠŸèƒ½
1. âœ… æ”¯æŒä¸Šä¼ PDFæ–‡ä»¶
2. âœ… è‡ªåŠ¨æå–PDFç¬¬ä¸€é¡µä½œä¸ºå°é¢
3. âœ… AIåˆ†æPDFå†…å®¹
4. âœ… çº¢è‰²"PDF"æ ‡è¯†
5. âœ… ä¸‹è½½åŸå§‹PDFæ–‡ä»¶

### æŠ€æœ¯æ”¹è¿›
1. âœ… ä½¿ç”¨pdfjs-distè¿›è¡ŒPDFæ¸²æŸ“
2. âœ… ä¿æŒPSDåŠŸèƒ½å®Œæ•´æ€§
3. âœ… å‘åå…¼å®¹ç°æœ‰åŠŸèƒ½
4. âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

---

**éƒ¨ç½²è´Ÿè´£äºº**: [å¡«å†™]
**éƒ¨ç½²æ—¶é—´**: [å¡«å†™]
**éªŒè¯äºº**: [å¡«å†™]
**çŠ¶æ€**: â³ å¾…éƒ¨ç½²

**å¤‡æ³¨**: 
- æœ¬æ¬¡æ›´æ–°ä¸ºåŠŸèƒ½å¢å¼ºï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- å»ºè®®åœ¨ä½å³°æœŸéƒ¨ç½²
- éƒ¨ç½²åè¯·å®Œæ•´æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
