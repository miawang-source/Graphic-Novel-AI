# 🔍 线上剧本分析功能问题诊断

## 问题描述
- **现象**：线上版本（Vercel）的剧本分析功能失败，提示"分析失败，请检查网络连接"
- **对比**：画布功能（同样调用 OpenRouter API）正常工作
- **环境**：Vercel 已配置 `OPENROUTER_API_KEY` 环境变量

## 🎯 最可能的原因：请求体过大（413 错误）

### Vercel 限制
- **请求体大小限制**：4.5MB
- **响应体大小限制**：4.5MB
- **函数执行时间**：Hobby 10秒，Pro 60秒

### 为什么画布功能正常，剧本分析失败？

| 功能 | 请求内容 | 典型大小 | 是否超限 |
|------|----------|----------|----------|
| 画布功能 | 图片 base64 + 简短提示词 | < 2MB | ❌ 不超限 |
| 剧本分析 | 完整剧本文本 | 可能 > 4.5MB | ✅ 可能超限 |

**关键差异**：
- 画布功能发送的是单张图片 + 短提示词
- 剧本分析发送的是完整的长篇剧本文本
- 如果剧本文本超过 4.5MB（约 450万字符），Vercel 会直接拒绝请求，返回 413 错误

## ✅ 已实施的修复

### 1. 添加请求体大小检查
```typescript
// app/api/analyze-script/route.ts
const contentSize = new Blob([content]).size
const maxSize = 3 * 1024 * 1024 // 3MB 安全限制
if (contentSize > maxSize) {
  return NextResponse.json({ 
    error: `剧本内容过大（${(contentSize / 1024 / 1024).toFixed(2)}MB），超过限制（3MB）`,
    contentSize,
    maxSize
  }, { status: 413 })
}
```

### 2. 改进前端错误处理
```typescript
// app/page.tsx
if (response.status === 413) {
  throw new Error(errorData.error || "剧本内容过大，请分段分析或删减内容")
}

// 显示后端返回的具体错误信息
if (error.message) {
  errorMessage = error.message
}
```

### 3. 配置请求体大小限制
```typescript
export const config = {
  api: {
    bodyParser: {
      sizeLimit: '4mb',
    },
  },
}
```

## 🧪 诊断步骤

### 步骤 1：检查剧本大小
在浏览器控制台（F12）运行：
```javascript
// 假设你的剧本内容在变量 content 中
const size = new Blob([content]).size
console.log(`剧本大小: ${(size / 1024 / 1024).toFixed(2)} MB`)
console.log(`字符数: ${content.length}`)
```

**判断标准**：
- ✅ < 3MB：应该正常
- ⚠️ 3-4.5MB：可能失败
- ❌ > 4.5MB：肯定失败

### 步骤 2：查看浏览器网络请求
1. 打开浏览器开发者工具（F12）
2. 切换到 `Network` 标签
3. 尝试分析剧本
4. 查找 `analyze-script` 请求

**检查点**：
- **Status Code**：
  - `413`：请求体过大 ✅ 确认是大小问题
  - `500`：服务器错误
  - `408`：超时
  - `Failed`：网络错误或 CORS 问题

- **Response**：
  - 查看返回的错误信息
  - 如果是 413，会看到"剧本内容过大"的提示

### 步骤 3：测试诊断 API
访问：`https://你的域名.vercel.app/api/analyze-script`

**期望返回**：
```json
{
  "status": "ready",
  "env": {
    "hasApiKey": true,
    "apiKeyPrefix": "sk-or-v1-bb5"
  }
}
```

**如果返回**：
- `hasApiKey: false`：环境变量未配置 ❌
- `hasApiKey: true`：环境变量配置正确 ✅

### 步骤 4：测试小剧本
用一个很短的剧本（< 1000 字）测试：

```
标题：测试
内容：这是一个测试剧本。主角小明走进了房间。
```

**结果判断**：
- ✅ 成功：说明 API 和环境变量都正常，问题确实是剧本太大
- ❌ 失败：说明有其他问题（环境变量、API 密钥、网络等）

## 🔧 解决方案

### 方案 1：分段分析（推荐）
将长剧本分成多个部分，分别分析：

```typescript
// 伪代码
const chunkSize = 50000 // 每段 5万字符
const chunks = []
for (let i = 0; i < content.length; i += chunkSize) {
  chunks.push(content.substring(i, i + chunkSize))
}

// 分别分析每段
for (const chunk of chunks) {
  await analyzeScript(chunk)
}
```

### 方案 2：压缩文本
删除不必要的空格、换行、注释：

```typescript
const compressed = content
  .replace(/\s+/g, ' ')  // 多个空格替换为单个
  .replace(/\n+/g, '\n') // 多个换行替换为单个
  .trim()
```

### 方案 3：升级 Vercel 计划
- Hobby（免费）：4.5MB 限制
- Pro（$20/月）：4.5MB 限制（相同）
- Enterprise：可以自定义限制

**注意**：升级到 Pro 不会增加请求体大小限制！

### 方案 4：使用外部存储
1. 将剧本上传到 Supabase Storage
2. API 只传递文件 URL
3. 后端从 URL 下载内容

```typescript
// 前端
const { data } = await supabase.storage
  .from('scripts')
  .upload(`${scriptId}.txt`, content)

await fetch('/api/analyze-script', {
  body: JSON.stringify({ 
    scriptUrl: data.path,
    title 
  })
})

// 后端
const response = await supabase.storage
  .from('scripts')
  .download(scriptUrl)
const content = await response.data.text()
```

## 📊 其他可能的问题

### 问题 2：函数超时
**症状**：请求很久后返回 504 或超时错误

**原因**：
- Hobby 计划：10 秒超时
- 剧本分析可能需要更长时间

**解决**：
- 升级到 Pro 计划（60 秒超时）
- 优化 prompt，减少 AI 处理时间
- 使用更快的模型（如 gemini-1.5-flash）

### 问题 3：CORS 错误
**症状**：浏览器控制台显示 CORS 错误

**检查**：
```typescript
// next.config.mjs
headers: [
  { 
    key: 'Access-Control-Allow-Origin', 
    value: process.env.NEXT_PUBLIC_SITE_URL || '*' 
  }
]
```

**解决**：
- 确保 `NEXT_PUBLIC_SITE_URL` 配置正确
- 或者设置为 `'*'` 允许所有来源

### 问题 4：环境变量未生效
**症状**：诊断 API 返回 `hasApiKey: false`

**解决**：
1. 检查 Vercel Dashboard → Settings → Environment Variables
2. 确保勾选了 ✅ Production 环境
3. 重新部署（Deployments → Redeploy）

## 🎯 推荐操作流程

1. **立即测试**：
   ```bash
   # 提交代码
   git add .
   git commit -m "fix: 添加请求体大小检查和改进错误处理"
   git push
   ```

2. **等待部署完成**（约 2-3 分钟）

3. **测试诊断 API**：
   - 访问 `https://你的域名.vercel.app/api/analyze-script`
   - 确认 `hasApiKey: true`

4. **测试小剧本**：
   - 用 < 1000 字的短剧本测试
   - 如果成功，说明 API 正常

5. **测试实际剧本**：
   - 用你的实际剧本测试
   - 查看浏览器控制台的错误信息
   - 如果是 413 错误，使用分段分析方案

## 📞 需要更多帮助？

如果按照以上步骤还是无法解决，请提供：

1. **浏览器控制台截图**（Network 标签）
2. **剧本大小**（字符数和 MB）
3. **错误信息**（完整的错误提示）
4. **诊断 API 返回结果**
5. **Vercel 计划类型**（Hobby/Pro）

---

**总结**：最可能的原因是剧本内容超过 Vercel 的 4.5MB 请求体限制。建议先测试小剧本确认 API 正常，然后使用分段分析方案处理长剧本。

