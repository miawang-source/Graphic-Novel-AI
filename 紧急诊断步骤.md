# 🚨 紧急诊断步骤

## 问题重新分析

**关键信息**：
- ✅ 之前线上版本可以正常工作
- ❌ 现在突然不行了（小剧本也不行）
- ✅ 画布功能（同样调用 OpenRouter）正常
- ✅ Vercel 已配置 OPENROUTER_API_KEY

**结论**：不是请求体大小问题，不是环境变量未配置问题。

## 🔍 可能的原因

### 最可能：Vercel 环境变量格式问题

**发现**：
- 画布功能：直接使用 `process.env.OPENROUTER_API_KEY`（没有严格验证）
- 剧本分析：先用 `validateOpenRouterKey()` 验证格式

**验证函数**：
```typescript
export function validateOpenRouterKey(apiKey: string | undefined): boolean {
  if (!apiKey) return false
  return apiKey.startsWith('sk-or-v1-') && apiKey.length > 20
}
```

**可能的问题**：
1. Vercel 环境变量中的密钥有**多余的空格**
2. Vercel 环境变量中的密钥有**换行符**
3. Vercel 环境变量被**意外修改**或**删除**

## ✅ 已实施的修复

### 1. 增强诊断 API
访问 `https://你的域名.vercel.app/api/analyze-script` 会返回：

```json
{
  "status": "ready",
  "env": {
    "hasApiKey": true/false,
    "apiKeyPrefix": "sk-or-v1-xxx",
    "apiKeyLength": 68,
    "apiKeySuffix": "xxxx",
    "isValidFormat": true/false,
    "startsWithCorrectPrefix": true/false,
    "hasWhitespace": true/false,  // 关键！
    "trimmedLength": 68
  }
}
```

**关键检查点**：
- `hasWhitespace: true` → 密钥有空格，需要修复
- `isValidFormat: false` → 密钥格式不对
- `apiKeyLength` 和 `trimmedLength` 不一致 → 有空格或换行

### 2. 统一了两个 API 的密钥使用方式
现在画布和剧本分析都使用相同的验证逻辑。

## 🧪 立即测试步骤

### 步骤 1：提交代码并部署
```bash
git add .
git commit -m "fix: 增强 API 密钥诊断功能"
git push
```

等待 Vercel 自动部署（2-3 分钟）

### 步骤 2：访问诊断 API
```
https://你的域名.vercel.app/api/analyze-script
```

**查看返回结果**，特别注意：
- `isValidFormat`: 应该是 `true`
- `hasWhitespace`: 应该是 `false`
- `apiKeyLength`: 应该是 68 左右
- `trimmedLength`: 应该等于 `apiKeyLength`

### 步骤 3：根据诊断结果修复

#### 情况 A：`hasWhitespace: true` 或 `apiKeyLength !== trimmedLength`
**原因**：Vercel 环境变量有多余空格

**解决**：
1. 登录 Vercel Dashboard
2. Settings → Environment Variables
3. 找到 `OPENROUTER_API_KEY`
4. 点击编辑，**重新粘贴密钥**（确保没有空格）
5. 保存后重新部署

#### 情况 B：`isValidFormat: false` 但 `hasApiKey: true`
**原因**：密钥格式不对

**解决**：
1. 检查密钥是否以 `sk-or-v1-` 开头
2. 检查密钥长度是否 > 20
3. 如果不对，重新从 OpenRouter 获取密钥

#### 情况 C：`hasApiKey: false`
**原因**：环境变量未配置或被删除

**解决**：
1. 在 Vercel 重新配置 `OPENROUTER_API_KEY`
2. 确保勾选 Production 环境
3. 重新部署

## 🎯 最可能的解决方案

基于你的描述（之前能用，现在不能用），最可能是：

**Vercel 环境变量被意外修改，导致有多余的空格或换行符**

### 快速修复步骤：
1. 登录 Vercel Dashboard
2. 进入你的项目
3. Settings → Environment Variables
4. 找到 `OPENROUTER_API_KEY`
5. **删除这个变量**
6. **重新添加**：
   - Name: `OPENROUTER_API_KEY`
   - Value: `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`
   - Environments: ✅ Production ✅ Preview ✅ Development
7. 保存
8. Deployments → 找到最新部署 → Redeploy

## 📞 下一步

1. **立即提交代码**并等待部署
2. **访问诊断 API**查看详细信息
3. **告诉我诊断结果**，特别是：
   - `isValidFormat` 的值
   - `hasWhitespace` 的值
   - `apiKeyLength` 和 `trimmedLength` 的值

根据这些信息，我可以精确定位问题！

---

**重要**：诊断 API 会暴露部分密钥信息（前 12 位和后 4 位），仅用于调试。调试完成后可以删除这个 GET 端点。

